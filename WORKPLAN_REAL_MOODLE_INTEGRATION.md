# תוכנית עבודה - אינטגרציה אמיתית עם Moodle

## מטרה סופית
להגיע למצב שבו המערכת אוספת את כל הפריטים מכל קורס של המשתמש, מנתחת אותם באמצעות מערכת הניתוח שבנינו, מסווגת אותם ומתאימה אותם לטבלאות הדאטהבייס. רק לאחר שכל האינטגרציה תושלם והמידע יעבור כמו שצריך לטבלאות, נחליף את המידע הפיקטיבי בדשבורד למידע אמיתי.

## פרטי חיבור למודל
- **כתובת Moodle**: https://moodle.bgu.ac.il
- **טכנולוגיית איסוף נתונים**: Playwright
- **שפה**: עברית (המערכת תומכת בעברית, אנגלית וערבית)

---

## שלב 1: ניקוי והכנה

### 1.1 ניקוי הדאטהבייס
- [x] יצירת מיגרציה SQL לניקוי כל הנתונים הקיימים
- [x] מחיקת כל ה-Mock Data מהטבלאות
- [x] איפוס כל הטבלאות הרלוונטיות
- [x] וידוא שהדאטהבייס נקי לחלוטין
- [x] **בדיקה אוטומטית**: וידוא שכל הטבלאות ריקות ומוכנות

### 1.2 ביטול Mock Data (רק בחלק האחורי)
- [x] זיהוי כל המקומות בקוד שיוצרים Mock Data
- [x] הסרת או השבתת כל הפונקציות שיוצרות נתונים מדומים
- [x] וידוא שהמערכת לא תייצר יותר Mock Data
- [x] **שמירה על Mock Data בדשבורד עד סיום האינטגרציה המלאה**
- [x] **בדיקה אוטומטית**: וידוא שאין יצירת Mock Data חדש

---

## שלב 2: חיבור אמיתי למודל

### 2.1 הגדרת פרטי התחברות
- [ ] הגדרת פרטי התחברות למודל של המשתמש
- [ ] יצירת מערכת אחסון מאובטחת לפרטי התחברות
- [ ] הגדרת משתני סביבה לפרטי החיבור
- [ ] וידוא שהפרטים נשמרים בצורה מאובטחת
- [ ] **בדיקה אוטומטית**: וידוא שהפרטים נשמרים ומאובטחים

### 2.2 פיתוח מודול חיבור למודל
- [ ] יצירת מודול התחברות למודל עם Playwright
- [ ] פיתוח מערכת ניהול סשן למודל
- [ ] טיפול בשגיאות התחברות
- [ ] מערכת ניסיונות חוזרים במקרה של כישלון
- [ ] **בדיקה אוטומטית**: וידוא התחברות מוצלחת למודל

---

## שלב 3: איסוף נטו של פריטים מכל קורס

### 3.1 איסוף רשימת קורסים ✅ הושלם
- [x] פיתוח סקריפט Playwright לאיסוף רשימת הקורסים של המשתמש
- [x] מיפוי המבנה של דפי הקורסים במודל
- [x] יצירת פונקציה לחילוץ מידע בסיסי על קורסים
- [x] טיפול בכמה דפים של קורסים (pagination)
- [x] **בדיקה אוטומטית**: וידוא איסוף רשימת קורסים מלאה ומדויקת

#### 📋 פרטי ההשלמה:
- **סקריפט**: `moodle_courses_scraper.py`
- **טכנולוגיה**: Playwright עם Firefox
- **סלקטור**: `h5.multiline` לחילוץ שמות קורסים
- **שמירה לדטה בייס**: טבלת `courses` ב-Supabase
- **מידע מחולץ**: שם, קוד, סמסטר, שנת לימודים, פקולטה
- **מדריך מפורט**: `MOODLE_COURSES_SYNC_GUIDE.md`

#### 🎯 תוצאות:
- ✅ 10 קורסים מחולצים בהצלחה
- ✅ כל הקורסים נשמרים בדטה בייס עם UUID
- ✅ ניתוח אוטומטי של סמסטר, שנה ופקולטה
- ✅ קובץ JSON לגיבוי עם timestamp

### 3.2 איסוף כל הפריטים מכל קורס 🔄 בפיתוח
- [x] פיתוח סקריפט Playwright לאיסוף **כל הפריטים** מכל קורס
- [x] איסוף sections, files, assignments, announcements, exams, emails
- [x] איסוף מידע על teaching staff
- [x] איסוף כל הקבצים המצורפים
- [x] שמירה זמנית של כל הנתונים הגולמיים
- [ ] **בדיקה אוטומטית**: וידוא איסוף כל סוגי הפריטים מכל קורס

### 3.3 סיווג וניקוי נתונים
- [ ] יצירת מערכת סיווג לנתוני הקורסים
- [ ] ניקוי ועיבוד הנתונים שנאספו
- [ ] המרת פורמטים (תאריכים, טקסטים וכו')
- [ ] וידוא תקינות הנתונים
- [ ] **בדיקה אוטומטית**: וידוא תקינות וסיווג נכון של כל הנתונים

---

## שלב 4: ניתוח פריטים באמצעות מערכת הניתוח

### 4.1 שימוש במערכת הניתוח הקיימת
- [ ] חיבור מערכת הניתוח הקיימת (`spike-analyzer`)
- [ ] ניתוח כל הפריטים שנאספו
- [ ] סיווג אוטומטי של פריטים לפי סוג (מטלה, הודעה, קובץ וכו')
- [ ] זיהוי רמת קושי של מטלות
- [ ] זיהוי חשיבות של הודעות
- [ ] **בדיקה אוטומטית**: וידוא ניתוח מוצלח של כל הפריטים

### 4.2 התאמה לטבלאות הדאטהבייס
- [ ] מיפוי תוצאות הניתוח לטבלאות המתאימות
- [ ] יצירת פונקציות שמירה לכל סוג פריט
- [ ] שמירה בטבלאות: `courses`, `course_enrollments`, `assignments`, `announcements`, `exams`, `emails`, `teaching_staff`, `course_files`
- [ ] וידוא שהנתונים נשמרים עם ה-Service Role
- [ ] **בדיקה אוטומטית**: וידוא שמירה מוצלחת בכל הטבלאות

### 4.3 שמירת תוצאות הניתוח
- [ ] שמירת תוצאות הניתוח בטבלת `content_analysis`
- [ ] שמירת priority_score לכל פריט
- [ ] שמירת difficulty_score למטלות
- [ ] שמירת metadata נוסף לפי הצורך
- [ ] **בדיקה אוטומטית**: וידוא שמירת כל תוצאות הניתוח

---

## שלב 5: בדיקות ואופטימיזציה של האינטגרציה

### 5.1 בדיקות פונקציונליות
- [ ] בדיקת איסוף נתונים אמיתיים ממודל
- [ ] בדיקת ניתוח הפריטים
- [ ] בדיקת שמירה בדאטהבייס
- [ ] בדיקת תקינות הנתונים בטבלאות
- [ ] **בדיקה אוטומטית**: וידוא כל הפונקציונליות עובדת

### 5.2 אופטימיזציה
- [ ] אופטימיזציה של זמני איסוף
- [ ] אופטימיזציה של שמירה בדאטהבייס
- [ ] אופטימיזציה של זיכרון
- [ ] אופטימיזציה של רשת
- [ ] **בדיקה אוטומטית**: וידוא שיפור ביצועים

### 5.3 בדיקות מקיפות
- [ ] בדיקת כל סוגי הפריטים
- [ ] בדיקת כל הקורסים
- [ ] בדיקת תקינות הניתוח
- [ ] בדיקת שלמות הנתונים
- [ ] **בדיקה אוטומטית**: וידוא שלמות כל המערכת

---

## שלב 6: עדכון מערכת הסנכרון

### 6.1 עדכון מערכת הסנכרון
- [ ] עדכון `background-sync.ts` לעבודה עם נתונים אמיתיים
- [ ] עדכון מערכת ה-sync jobs
- [ ] יצירת מערכת ניטור סנכרון
- [ ] טיפול בשגיאות סנכרון
- [ ] **בדיקה אוטומטית**: וידוא סנכרון מוצלח

### 6.2 אינטגרציה עם מערכת הניתוח
- [ ] חיבור מערכת הסנכרון עם מערכת הניתוח
- [ ] יצירת workflow אוטומטי: איסוף → ניתוח → שמירה
- [ ] טיפול בשגיאות בכל שלב
- [ ] מערכת retry אוטומטית
- [ ] **בדיקה אוטומטית**: וידוא workflow מלא עובד

---

## שלב 7: החלפת Mock Data בדשבורד (רק לאחר השלמת כל האינטגרציה)

### 7.1 וידוא שלמות האינטגרציה
- [ ] בדיקה מקיפה שכל הנתונים עוברים כמו שצריך
- [ ] בדיקה שכל הניתוחים עובדים
- [ ] בדיקה שכל הטבלאות מכילות נתונים תקינים
- [ ] בדיקת ביצועים של המערכת
- [ ] **בדיקה אוטומטית**: וידוא שלמות כל האינטגרציה

### 7.2 החלפת Mock Data
- [ ] עדכון קומפוננטות להצגת נתונים אמיתיים
- [ ] עדכון מערכת הטעינה
- [ ] הוספת אינדיקטורים לסנכרון
- [ ] טיפול במצבי שגיאה
- [ ] **בדיקה אוטומטית**: וידוא הצגת נתונים אמיתיים

### 7.3 בדיקות סופיות
- [ ] בדיקת הצגה בממשק
- [ ] בדיקת ביצועים
- [ ] בדיקת חוויית משתמש
- [ ] בדיקת יציבות המערכת
- [ ] **בדיקה אוטומטית**: וידוא יציבות המערכת

---

## קבצים וטכנולוגיות נדרשים

### קבצים לפתח/לעדכן:
1. `apps/web/lib/moodle-connector.ts` - מודול חיבור למודל עם Playwright
2. `apps/web/lib/data-collectors/` - סקריפטי איסוף נתונים עם Playwright
3. `apps/web/lib/data-processors/` - מערכות עיבוד נתונים
4. `apps/web/lib/background-sync.ts` - עדכון מערכת הסנכרון
5. `spike-analyzer/` - שימוש במערכת הניתוח הקיימת
6. `supabase/migrations/` - מיגרציות לניקוי ועדכון מבנה
7. `tests/` - קבצי בדיקה אוטומטית לכל שלב

### טכנולוגיות:
- **Playwright** לאיסוף נתונים (במקום Puppeteer)
- **Supabase** לניהול דאטהבייס
- **Next.js** לפרונט-אנד
- **TypeScript** לפיתוח
- **Python** (spike-analyzer) לניתוח נתונים
- **Docker** לפריסה

---

## סדר עדיפויות

### עדיפות גבוהה (שלב ראשון):
1. ניקוי הדאטהבייס
2. חיבור אמיתי למודל עם Playwright
3. איסוף נטו של כל הפריטים מכל קורס
4. ניתוח הפריטים באמצעות מערכת הניתוח הקיימת

### עדיפות בינונית (שלב שני):
1. התאמה לטבלאות הדאטהבייס
2. עדכון מערכת הסנכרון
3. בדיקות ואופטימיזציה

### עדיפות נמוכה (שלב שלישי):
1. החלפת Mock Data בדשבורד (רק לאחר השלמת כל האינטגרציה)
2. אופטימיזציה וניטור מתקדם

---

## הערות חשובות

1. **שמירה על Mock Data בדשבורד** - לא לשנות את הדשבורד עד שכל האינטגרציה תושלם
2. **בדיקות אוטומטיות בכל שלב** - יש לבצע בדיקות מקיפות אחרי כל תת-שלב
3. **גיבוי נתונים** - יש לגבות נתונים לפני כל שינוי משמעותי
4. **תיעוד** - יש לתעד כל שינוי ופיתוח
5. **אבטחה** - יש לוודא שפרטי התחברות מאובטחים
6. **ביצועים** - יש לשים לב לביצועים בכל שלב
7. **שימוש במערכת הניתוח הקיימת** - להשתמש ב-`spike-analyzer` במקום לבנות מערכת חדשה
8. **שימוש ב-Playwright** - להשתמש ב-Playwright לאיסוף נתונים במקום Puppeteer
9. **כתובת Moodle נכונה** - להשתמש ב-https://moodle.bgu.ac.il

---

## סיכום

תוכנית זו מתמקדת באיסוף נטו של כל הפריטים מכל קורס באמצעות Playwright, ניתוח שלהם באמצעות מערכת הניתוח הקיימת, והתאמתם לטבלאות הדאטהבייס. רק לאחר שכל האינטגרציה תושלם והמידע יעבור כמו שצריך, נחליף את המידע הפיקטיבי בדשבורד למידע אמיתי.

**כל תת-שלב כולל בדיקה אוטומטית לוידוא שהשלב הושלם בהצלחה.** 