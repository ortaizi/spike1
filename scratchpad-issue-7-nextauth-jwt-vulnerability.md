# Scratchpad: Issue #7 - NextAuth JWT Dependency Vulnerability

**GitHub Issue**: https://github.com/ortaizi/spike1-1/issues/7 **Severity**:
Critical üî¥ **Priority**: IMMEDIATE - Week 1 **CVE**: CVE-2024-28176 - Resource
exhaustion in jose < 2.0.7

## Problem Analysis

### Current State

- **Vulnerable dependency**: jose library < 2.0.7 used by NextAuth
- **Current NextAuth version**: 4.24.11 (apps/web/package.json)
- **Current @types/next-auth version**: 3.13.0 (root package.json)
- **Audit confirmation**: npm audit shows jose vulnerability
  (GHSA-hhhv-q57g-882q)

### Vulnerability Details (CVE-2024-28176)

1. **Resource exhaustion** via specifically crafted JWE with compressed
   plaintext
2. **Attack vector**: Malformed JWT tokens can cause excessive CPU/memory
   consumption
3. **Impact**: Denial of Service (DoS) attacks leading to application
   unavailability
4. **CVSS Score**: 5.3 (Moderate, but critical for production systems)
5. **Affected versions**: jose < 2.0.7 (v1.x/v2.x) and < 4.15.5 (v3.x/v4.x)

### Security Risks

1. **Application DoS** through crafted JWT tokens
2. **Resource exhaustion** causing server unavailability
3. **Performance degradation** affecting all users
4. **Potential cascading failures** in microservices architecture

## Implementation Plan

### Phase 1: Dependency Analysis and Preparation

1. **Identify exact jose version** currently in use via dependency tree
2. **Check NextAuth compatibility** with latest versions
3. **Review breaking changes** between current and target versions
4. **Backup current auth configuration** for rollback if needed

### Phase 2: NextAuth Ecosystem Update

1. **Update next-auth** to latest stable version (5.x if stable, otherwise
   latest 4.x)
2. **Update @types/next-auth** to latest compatible version
3. **Update @auth/supabase-adapter** to ensure compatibility
4. **Verify jose dependency** is updated to >= 2.0.7

### Phase 3: Configuration Review and Testing

1. **Review auth configuration** for deprecated options
2. **Update unified-auth.ts** if breaking changes exist
3. **Test local authentication flows** thoroughly
4. **Verify Supabase adapter compatibility**

### Phase 4: Security Validation

1. **Run npm audit** to confirm vulnerability resolution
2. **Test JWT token processing** with various payloads
3. **Performance testing** to ensure no regression
4. **Security scan** with updated dependencies

## Technical Approach

### Dependency Updates Required

```json
// Root package.json updates
{
  "@types/next-auth": "^4.21.0" // Update from ^3.13.0
}

// apps/web/package.json updates
{
  "next-auth": "^4.24.16", // Update to latest 4.x stable
  "@auth/supabase-adapter": "^1.10.0" // Ensure compatibility
}
```

### Compatibility Verification

```bash
# Check current dependency tree
npm ls jose

# After updates, verify jose version
npm ls jose | grep jose

# Ensure version >= 2.0.7
```

### Auth Configuration Updates

- Review `apps/web/lib/auth/unified-auth.ts` for deprecated options
- Check JWT configuration for compatibility
- Ensure Supabase adapter works with new versions
- Verify session and token configurations

## Files to Modify

### Package Management

- `package.json` (root) - Update @types/next-auth
- `apps/web/package.json` - Update next-auth and adapter
- `package-lock.json` - Will be regenerated

### Potential Auth Configuration (if breaking changes)

- `apps/web/lib/auth/unified-auth.ts` - NextAuth configuration
- `apps/web/middleware.ts` - Auth middleware (verify compatibility)
- Any API routes using NextAuth - Check for deprecated imports

## Testing Strategy

### Security Testing

1. **npm audit** - Verify no critical/high vulnerabilities
2. **Dependency scan** - Confirm jose >= 2.0.7 in tree
3. **JWT stress test** - Process various token formats safely
4. **Resource monitoring** - Ensure no memory leaks

### Functional Testing

1. **Authentication flow** - Login/logout with Google OAuth
2. **Session management** - Verify sessions persist correctly
3. **University credentials** - Test BGU integration flow
4. **Middleware protection** - Verify protected routes work
5. **API authentication** - Test API route protection

### Regression Testing

1. **Full test suite** - `npm run test:auth-critical`
2. **E2E authentication** - `npm run test:auth-e2e`
3. **Hebrew/RTL** - `npm run test:hebrew`
4. **Visual regression** - Ensure auth UI unchanged

## Success Criteria

- [ ] jose dependency updated to >= 2.0.7
- [ ] npm audit shows no critical/high vulnerabilities
- [ ] All authentication flows work correctly
- [ ] No breaking changes in user experience
- [ ] Performance maintained or improved
- [ ] Full test suite passes (auth-critical, e2e, hebrew)
- [ ] NextAuth session management unchanged
- [ ] Supabase integration unaffected

## Rollback Plan

If critical issues arise:

1. **Immediate revert** - Restore previous package.json versions
2. **Clear node_modules** - `npm run fresh-install`
3. **Restart development server** - Follow CLAUDE.md protocol
4. **Monitor logs** - Check for auth errors
5. **Incremental rollforward** - Update dependencies one by one

## Risk Assessment

### Low Risk (Expected)

- Minor NextAuth type updates
- Compatible jose library update
- No breaking changes in latest 4.x versions

### Medium Risk (Possible)

- Session configuration changes needed
- Supabase adapter compatibility issues
- Type definition mismatches

### High Risk (Unlikely but monitored)

- Breaking changes in NextAuth 5.x (avoid if unstable)
- JWT format changes requiring configuration updates
- Performance degradation from new jose implementation

## Notes

- **Priority**: This is a CRITICAL security fix that must be completed
  immediately
- **Hebrew RTL**: No impact expected on internationalization features
- **University integration**: BGU Moodle auth flow should be unaffected
- **Mobile compatibility**: No UI changes expected
- **Production deployment**: Test thoroughly before production update
- **Monitoring**: Watch resource usage after deployment to production

## Implementation Steps Summary

1. ‚úÖ **Research completed** - CVE details and impact understood
2. üîÑ **Create branch** - `fix/issue-7-nextauth-jwt-vulnerability`
3. ‚è≥ **Update dependencies** - NextAuth and related packages
4. ‚è≥ **Verify security** - Confirm jose >= 2.0.7
5. ‚è≥ **Test authentication** - All flows working
6. ‚è≥ **Run test suite** - Pass all security and functionality tests
7. ‚è≥ **Create PR** - Document security fix and testing results
