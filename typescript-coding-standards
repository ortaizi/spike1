# TypeScript Coding Standards - Spike Platform

## ğŸš€ ×¡×˜× ×“×¨×˜×™× ×œ×¤×™×ª×•×— ××¢×¨×›×ª ×¡× ×›×¨×•×Ÿ ××•×˜×•××˜×™

### ××¨×›×™×˜×§×˜×•×¨×ª ×§×‘×¦×™×
```
apps/web/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ operations.ts          # ×¤×¢×•×œ×•×ª ×“×˜×” ×‘×™×™×¡
â”‚   â”‚   â””â”€â”€ sync-jobs.ts          # × ×™×”×•×œ jobs
â”‚   â”œâ”€â”€ background-sync.ts         # ×ª×”×œ×™×š ×¨×§×¢
â”‚   â”œâ”€â”€ error-handler.ts           # ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ sync-status-messages.ts # ×”×•×“×¢×•×ª ×¡×˜×˜×•×¡
â”œâ”€â”€ app/api/
â”‚   â””â”€â”€ sync-status/
â”‚       â”œâ”€â”€ [jobId]/route.ts       # ×‘×“×™×§×ª ×¡×˜×˜×•×¡
â”‚       â””â”€â”€ active/route.ts        # job ×¤×¢×™×œ
â””â”€â”€ components/dashboard/
    â””â”€â”€ sync-progress.tsx          # ×¨×›×™×‘ ×”×ª×§×“××•×ª
```

### ×˜×™×¤×•×¡×™ × ×ª×•× ×™× (Types)
```typescript
// Sync Job Types
interface SyncJob {
  id: string;
  user_id: string;
  status: SyncStatus;
  progress: number;
  message?: string;
  data?: any;
  created_at: Date;
  updated_at: Date;
}

type SyncStatus = 
  | 'starting'
  | 'creating_tables'
  | 'fetching_courses'
  | 'analyzing_content'
  | 'classifying_data'
  | 'saving_to_database'
  | 'completed'
  | 'error';

// User Credentials
interface MoodleCredentials {
  moodle_username: string;
  moodle_password: string;
  university_id: string;
}

// Sync Progress
interface SyncProgress {
  jobId: string;
  status: SyncStatus;
  progress: number;
  message: string;
  error?: string;
}
```

### ×¤×•× ×§×¦×™×•×ª ×¢×™×§×¨×™×•×ª
```typescript
// ×™×¦×™×¨×ª job ×—×“×©
async function createSyncJob(userId: string): Promise<string> {
  const jobId = generateJobId();
  await db.insert('sync_jobs', {
    id: jobId,
    user_id: userId,
    status: 'starting',
    progress: 0
  });
  return jobId;
}

// ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ job
async function updateJobStatus(
  jobId: string, 
  status: SyncStatus, 
  progress: number,
  message?: string
): Promise<void> {
  await db.update('sync_jobs', jobId, {
    status,
    progress,
    message,
    updated_at: new Date()
  });
}

// ×”×ª×—×œ×ª ×¡× ×›×¨×•×Ÿ ×¨×§×¢
async function startBackgroundSync(
  userId: string, 
  credentials: MoodleCredentials
): Promise<string> {
  const jobId = await createSyncJob(userId);
  
  // ×”×¨×¦×” ×‘×¨×§×¢
  setImmediate(() => {
    performBackgroundSync(jobId, userId, credentials);
  });
  
  return jobId;
}
```

### ×¨×›×™×‘×™ React
```typescript
// ×¨×›×™×‘ ×”×ª×§×“××•×ª ×¡× ×›×¨×•×Ÿ
interface SyncProgressProps {
  jobId: string;
  onComplete?: () => void;
  onError?: (error: string) => void;
}

export function SyncProgress({ jobId, onComplete, onError }: SyncProgressProps) {
  const [progress, setProgress] = useState<SyncProgress | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const pollInterval = setInterval(async () => {
      try {
        const response = await fetch(`/api/sync-status/${jobId}`);
        const data = await response.json();
        
        setProgress(data);
        
        if (data.status === 'completed') {
          onComplete?.();
          clearInterval(pollInterval);
        } else if (data.status === 'error') {
          setError(data.message);
          onError?.(data.message);
          clearInterval(pollInterval);
        }
      } catch (err) {
        setError('×©×’×™××” ×‘×‘×“×™×§×ª ×¡×˜×˜×•×¡');
      }
    }, 2000);

    return () => clearInterval(pollInterval);
  }, [jobId, onComplete, onError]);

  if (error) {
    return <div className="text-red-500">×©×’×™××”: {error}</div>;
  }

  if (!progress) {
    return <div>×˜×•×¢×Ÿ...</div>;
  }

  return (
    <div className="sync-progress">
      <div className="progress-bar">
        <div 
          className="progress-fill" 
          style={{ width: `${progress.progress}%` }}
        />
      </div>
      <div className="progress-message">
        {getStatusMessage(progress.status)}
      </div>
    </div>
  );
}
```

### API Routes
```typescript
// ×‘×“×™×§×ª ×¡×˜×˜×•×¡ job
export async function GET(
  request: Request,
  { params }: { params: { jobId: string } }
) {
  try {
    const jobId = params.jobId;
    const job = await getSyncJobStatus(jobId);
    
    if (!job) {
      return Response.json({ error: 'Job ×œ× × ××¦×' }, { status: 404 });
    }
    
    return Response.json(job);
  } catch (error) {
    return Response.json(
      { error: '×©×’×™××” ×‘×‘×“×™×§×ª ×¡×˜×˜×•×¡' }, 
      { status: 500 }
    );
  }
}

// ×‘×“×™×§×ª job ×¤×¢×™×œ
export async function GET() {
  try {
    const userId = getCurrentUserId();
    const activeJob = await getActiveSyncJob(userId);
    
    return Response.json({
      hasActiveJob: !!activeJob,
      jobId: activeJob?.id,
      status: activeJob?.status,
      progress: activeJob?.progress
    });
  } catch (error) {
    return Response.json(
      { error: '×©×’×™××” ×‘×‘×“×™×§×ª job ×¤×¢×™×œ' }, 
      { status: 500 }
    );
  }
}
```

### ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
```typescript
// Retry mechanism
async function withRetry<T>(
  operation: () => Promise<T>,
  maxRetries: number = 3,
  baseDelay: number = 1000
): Promise<T> {
  let lastError: Error;
  
  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      return await operation();
    } catch (error) {
      lastError = error as Error;
      
      if (attempt === maxRetries) {
        throw lastError;
      }
      
      const delay = baseDelay * Math.pow(2, attempt);
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
  
  throw lastError!;
}

// Error handler
export function handleSyncError(error: unknown): string {
  if (error instanceof NetworkError) {
    return '×©×’×™××ª ×¨×©×ª - ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜';
  }
  
  if (error instanceof TimeoutError) {
    return '×¤×’ ×ª×•×§×£ ×”×‘×§×©×” - × ×¡×” ×©×•×‘';
  }
  
  if (error instanceof AuthError) {
    return '×©×’×™××ª ×”×ª×—×‘×¨×•×ª - ×‘×“×•×§ ×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª';
  }
  
  return '×©×’×™××” ×œ× ×™×“×•×¢×” - × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨';
}
```

### ×”×•×“×¢×•×ª ×¡×˜×˜×•×¡
```typescript
// ×”×•×“×¢×•×ª ×‘×¢×‘×¨×™×ª
export function getStatusMessage(status: SyncStatus): string {
  const messages: Record<SyncStatus, string> = {
    starting: 'ğŸš€ ××ª×—×™×œ ×ª×”×œ×™×š ×¡× ×›×¨×•×Ÿ...',
    creating_tables: 'ğŸ—ï¸ ×‘×•×“×§ ×•××™×™×¦×¨ ×˜×‘×œ××•×ª × ×“×¨×©×•×ª...',
    fetching_courses: 'ğŸ“Š ××•×¡×£ × ×ª×•× ×™ ×§×•×¨×¡×™× ××”××•×“×œ...',
    analyzing_content: 'ğŸ” ×× ×ª×— ×ª×•×›×Ÿ ×§×•×¨×¡×™×...',
    classifying_data: 'ğŸ—‚ï¸ ××¡×•×•×’ ×•×××¨×’×Ÿ × ×ª×•× ×™×...',
    saving_to_database: 'ğŸ’¾ ×©×•××¨ × ×ª×•× ×™× ×‘×“×˜×” ×‘×™×™×¡...',
    completed: 'âœ… ×¡× ×›×¨×•×Ÿ ×”×•×©×œ× ×‘×”×¦×œ×—×”!',
    error: 'âŒ ×©×’×™××” ×‘×ª×”×œ×™×š ×”×¡× ×›×¨×•×Ÿ'
  };
  
  return messages[status];
}
```

### ×¡×˜× ×“×¨×˜×™ ×§×•×“
```typescript
// Naming conventions
const syncJobId = 'job-123';           // camelCase
const SYNC_TIMEOUT = 300000;           // UPPER_SNAKE_CASE
const syncStatus: SyncStatus = 'starting'; // PascalCase for types

// Function naming
async function performBackgroundSync() {}    // verb + noun
async function updateJobStatus() {}         // verb + noun
async function getSyncJobStatus() {}        // get + noun

// Error handling
try {
  await riskyOperation();
} catch (error) {
  logger.error('Operation failed', { error, context });
  throw new CustomError('User-friendly message');
}

// Type safety
function processUserData(user: User): ProcessedUser {
  if (!user.id) {
    throw new ValidationError('User ID is required');
  }
  
  return {
    id: user.id,
    name: user.name || 'Unknown',
    email: user.email
  };
}
```

### ×”×’×“×¨×•×ª ×¡×‘×™×‘×”
```typescript
// Environment variables
const config = {
  JOB_POLLING_INTERVAL: parseInt(process.env.JOB_POLLING_INTERVAL || '2000'),
  JOB_TIMEOUT: parseInt(process.env.JOB_TIMEOUT || '300000'),
  JOB_CLEANUP_DAYS: parseInt(process.env.JOB_CLEANUP_DAYS || '7'),
  JOB_MAX_RETRIES: parseInt(process.env.JOB_MAX_RETRIES || '3'),
  AUTO_SYNC_ENABLED: process.env.AUTO_SYNC_ENABLED === 'true'
} as const;
```

## ğŸ¯ ×¡×™×›×•×

×¡×˜× ×“×¨×˜×™ ×”×§×•×“ ×”×—×“×©×™× ××¡×¤×§×™×:
- âœ… **Type Safety** - ×˜×™×¤×•×¡×™× ××“×•×™×§×™× ×œ×›×œ ×”× ×ª×•× ×™×
- âœ… **Error Handling** - ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ××§×™×£
- âœ… **Hebrew Support** - ×ª××™×›×” ××œ××” ×‘×¢×‘×¨×™×ª
- âœ… **Performance** - ×§×•×“ ××™×˜×‘×™ ×œ×‘×™×¦×•×¢×™×
- âœ… **Maintainability** - ×§×•×“ × ×§×™ ×•×§×¨×™×

**×”×¡×˜× ×“×¨×˜×™× ××•×›× ×™× ×œ×©×™××•×©!** ğŸš€ 