name: ğŸš€ Deploy Spike Academic Platform

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '20'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  # ================================================================================================
  # ğŸ” PRE-DEPLOYMENT VALIDATION
  # ================================================================================================
  
  pre-deployment-check:
    name: ğŸ” Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      environment: ${{ steps.check.outputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Determine deployment environment
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Check for breaking changes
        run: |
          echo "ğŸ” Checking for breaking changes since last deploy..."
          
          # Check for database migrations
          if git diff --name-only HEAD~1 | grep -q "supabase/migrations/"; then
            echo "âš ï¸  Database migration detected - ensure proper rollout strategy"
          fi
          
          # Check for major dependency updates
          if git diff --name-only HEAD~1 | grep -q "package-lock.json"; then
            echo "ğŸ“¦ Dependency changes detected"
          fi
          
          echo "âœ… Pre-deployment checks completed"

  # ================================================================================================
  # ğŸ—ï¸ BUILD FOR PRODUCTION
  # ================================================================================================
  
  build-production:
    name: ğŸ—ï¸ Production Build
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    if: needs.pre-deployment-check.outputs.should-deploy == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Run type check
        run: npm run type-check

      - name: ğŸ—ï¸ Build production bundle
        run: |
          echo "ğŸ—ï¸ Building Spike Academic Platform for production..."
          npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

      - name: ğŸ“Š Bundle analysis
        run: |
          echo "ğŸ“Š Analyzing production bundle..."
          if [ -d "apps/web/.next" ]; then
            echo "ğŸ“¦ Next.js build size:"
            du -sh apps/web/.next
            
            # Check for large bundles
            find apps/web/.next -name "*.js" -size +500k | while read file; do
              echo "âš ï¸  Large bundle detected: $file ($(du -h "$file" | cut -f1))"
            done
          fi

      - name: ğŸ“¦ Cache production build
        uses: actions/cache@v4
        with:
          path: |
            apps/web/.next
            apps/web/out
          key: production-build-${{ github.sha }}
          retention-days: 7

  # ================================================================================================
  # ğŸ§ª PRODUCTION SMOKE TESTS
  # ================================================================================================
  
  smoke-tests:
    name: ğŸ§ª Production Smoke Tests
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, build-production]
    if: needs.pre-deployment-check.outputs.should-deploy == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“¦ Restore production build
        uses: actions/cache@v4
        with:
          path: |
            apps/web/.next
            apps/web/out
          key: production-build-${{ github.sha }}

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: ğŸ§ª Run critical path smoke tests
        run: |
          echo "ğŸ§ª Running production smoke tests..."
          # Start the production server
          cd apps/web && npm run start &
          SERVER_PID=$!
          
          # Wait for server to be ready
          sleep 10
          
          # Run basic smoke tests
          curl -f http://localhost:3000 || (echo "âŒ Health check failed" && exit 1)
          curl -f http://localhost:3000/api/health || (echo "âŒ API health check failed" && exit 1)
          
          # Run Hebrew/RTL smoke test
          npx playwright test tests/e2e/smoke-tests.spec.ts --project="Desktop Chrome" || true
          
          # Cleanup
          kill $SERVER_PID
        env:
          NODE_ENV: production

  # ================================================================================================
  # ğŸŒ DEPLOY TO VERCEL
  # ================================================================================================
  
  deploy-vercel:
    name: ğŸŒ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, build-production, smoke-tests]
    if: needs.pre-deployment-check.outputs.should-deploy == 'true'
    environment: ${{ needs.pre-deployment-check.outputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŒ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: ${{ needs.pre-deployment-check.outputs.environment == 'production' && '--prod' || '' }}
          working-directory: ./apps/web
          
      - name: ğŸ“ Deployment summary
        run: |
          echo "ğŸš€ Spike Academic Platform deployed successfully!"
          echo "Environment: ${{ needs.pre-deployment-check.outputs.environment }}"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

  # ================================================================================================
  # ğŸ§ª POST-DEPLOYMENT VERIFICATION
  # ================================================================================================
  
  post-deployment-verification:
    name: ğŸ§ª Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [deploy-vercel, pre-deployment-check]
    if: needs.pre-deployment-check.outputs.should-deploy == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: ğŸ§ª Run post-deployment tests
        run: |
          echo "ğŸ§ª Running post-deployment verification..."
          
          # Wait for deployment to be fully available
          sleep 30
          
          # Run Hebrew/RTL verification tests against production
          if [ "${{ needs.pre-deployment-check.outputs.environment }}" = "production" ]; then
            PLAYWRIGHT_BASE_URL="https://spike-academic.vercel.app" npm run test:auth-e2e -- --grep="CRITICAL"
          fi
        env:
          CI: true
          NODE_ENV: production
        continue-on-error: true

      - name: ğŸ“Š Performance monitoring setup
        run: |
          echo "ğŸ“Š Setting up performance monitoring..."
          # Add performance monitoring hooks here
          echo "âœ… Performance monitoring configured"

  # ================================================================================================
  # ğŸ“¢ DEPLOYMENT NOTIFICATIONS
  # ================================================================================================
  
  notify-deployment:
    name: ğŸ“¢ Deployment Notifications
    runs-on: ubuntu-latest
    needs: [deploy-vercel, post-deployment-verification, pre-deployment-check]
    if: always() && needs.pre-deployment-check.outputs.should-deploy == 'true'
    
    steps:
      - name: ğŸ“¢ Notify deployment status
        run: |
          echo "ğŸ“¢ Spike Academic Platform Deployment Summary"
          echo "=============================================="
          echo "Environment: ${{ needs.pre-deployment-check.outputs.environment }}"
          echo "Status: ${{ needs.deploy-vercel.result }}"
          echo "Verification: ${{ needs.post-deployment-verification.result }}"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          
          if [ "${{ needs.deploy-vercel.result }}" = "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ğŸ“ Spike Academic Platform is live and ready for BGU students!"
          else
            echo "âŒ Deployment failed - check logs for details"
            exit 1
          fi

      # Add Discord/Slack notification here if needed
      # - name: Discord notification
      #   uses: Ilshidur/action-discord@master
      #   with:
      #     args: 'Spike Academic Platform deployed successfully to ${{ needs.pre-deployment-check.outputs.environment }}!'
      #   env:
      #     DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}